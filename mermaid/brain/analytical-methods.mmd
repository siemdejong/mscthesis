%%{init: {'theme': 'default', "flowchart" : { "curve" : "bumpX" } } }%%

flowchart TD
    images[(Overview + close-up images)]
    targets[(Case # and diagnosis)]
    cc[(Locations per case)]
    annotations[(Pathologist annotations)]

    subgraph splits[Create splits]
        filter_data[Filter medulloblastoma and pilocytic astrocytoma]

        create_splits[Stratify on case #]

        filter_data --> create_splits
    end

    subgraph pretraining[Pretraining]
        SimCLR(ImageNet + SimCLR)
        ImageNet(ImageNet)
    end

    subgraph train[Training]
        features[(Features)]

        subgraph hps[Hyperparameter search]
            sh[Successive Halving split 1]

            sh_bv{{Lowest loss}}

            sh --> sh_bv
        end

        VarMIL(VarMIL)
        CCMIL(CCMIL)

        train_bv{{Lowest loss}}

        features --> VarMIL & CCMIL

        VarMIL & CCMIL --> hps

        sh_bv --> train_with_conf[Train]

        train_with_conf --> train_bv
    end

    subgraph test[Testing]
        inf([Informedness])
        best_inf{{Highest informedness}}
        F1([F1])
        PRAUC([PR-AUC])

        best_model{{Highest F1}}

        inf --> best_inf --> F1
        F1 --> best_model

        PRAUC
    end

    subgraph xai[XAI]
        subgraph pretrained_model[Pretrained model]
            tsne[t-SNE]
            nn[Nearest neighbours]
            tsne ~~~ nn
        end

        subgraph final[Final model]
            direction LR
            A[Attention map]
            IoU([Intersection over union])
            A --> IoU
        end
    end

    create_splits --> pretraining
    images & targets --> splits
    SimCLR & ImageNet --> features
    pretraining --> xai
    train_bv --> test
    best_model --> xai
    annotations ---------------> xai
    cc ------> CCMIL